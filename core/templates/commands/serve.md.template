---
@IF_CLAUDECODE@
description: Review changes via headless Claude and file issues
allowed-tools: Bash, Read, Glob, Grep, Edit, TodoWrite, Task
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
description: Review changes for quality and file issues
@ENDIF_OPENCODE@
---

@IF_KIRO@
**You are now executing this workflow.** Begin immediately with Step 1. Do not summarize, describe, or explain what you will do — just do it. If the user included any text in their message, that text is the input argument — use it directly, do not ask for it again.
@ENDIF_KIRO@

## Summary

@IF_CLAUDECODE@
**Review changes via headless Claude.** Part of prep → cook → serve → tidy.
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
**Review changes for quality.** Part of prep → cook → serve → tidy.
@ENDIF_OPENCODE@

After cooking (executing a task), you "serve" it for review before tidying up.

**Arguments:** `$ARGUMENTS` (optional) - Specific bead ID to review

**STOP after completing.** Show NEXT STEP and wait for user.

---

## Process

### Step 1: Collect Review Context

**If the user provided a bead ID:**
- Use that bead ID directly

**Otherwise:**
- Identify from the collected output below

Collect review context in one call:

#### Find Script

Locate `diff-collector.py`:
@IF_CLAUDECODE@

1. **Plugin installation** (most common):
   ```
   Glob(pattern="**/scripts/diff-collector.py", path="~/.claude/plugins")
   ```
   Usually: `~/.claude/plugins/cache/line-cook-marketplace/line/<version>/scripts/diff-collector.py`

2. **Current project** (for development):
   ```
   Glob(pattern="**/scripts/diff-collector.py")
   ```
@ENDIF_CLAUDECODE@

```bash
# Collect review context: bead identification, git diffs (truncated at 200 lines), file status
REVIEW=$(python3 <path-to-diff-collector.py> --json 2>/dev/null)
echo "$REVIEW"
```

The JSON output includes: `bead`, `changes`. Diffs are capped at 200 lines each to prevent context window blowout.

The bead details are in the JSON's `bead` field — use this directly for review context.

@IF_CLAUDECODE@
### Step 2: Polish Changes

Before review, automatically refine code for clarity. Extract modified files from the REVIEW JSON's `changes.files` array.

```
Use Task tool to invoke polisher subagent:
Task(description="Polish code changes", prompt="Polish the following files for clarity and consistency:

<list of modified files from REVIEW JSON changes.files>

Apply these principles:
- Preserve exact functionality (never change behavior)
- Reduce unnecessary complexity
- Improve naming clarity
- Follow project conventions from CLAUDE.md
- Remove dead code and redundancy
- Avoid nested ternaries (prefer if/else or switch)

Output: List of refinements made (file:line - change)", subagent_type="polisher")
```

**After polisher completes:**
- If changes were made, stage them: `git add <polished files>`
- Proceed to sous-chef review

### Step 3: Code Review

Delegate to sous-chef (reviewer) subagent:

```
Use Task tool to invoke sous-chef subagent:
Task(description="Review code changes for task <id>", prompt="Review the following changes for task: <bead title>

Task ID: <id>
Task description: <brief description>

Changes to review:
<git diff output or diff HEAD~1>

Project context:
<CLAUDE.md summary if available>

Review checklist:
- Correctness: Logic errors, edge cases, error handling
- Security: Input validation, secrets exposure, injection risks
- Style: Naming, consistency with codebase patterns
- Completeness: Does it fully address the task?

Output format:
1. Summary: Brief overall assessment
2. Verdict: ready_for_tidy | needs_changes | blocked
3. Issues found:
   - Severity: critical | major | minor | nit
   - File/line: Location
   - Issue: Description
   - Suggestion: How to fix
   - Auto-fixable: true | false
4. Positive notes: What was done well

CRITICAL: If verdict is 'blocked', explain why and what must be fixed.", subagent_type="sous-chef")
```

Wait for reviewer assessment. Address critical issues before proceeding to tidy.

**Manual fallback if sous-chef unavailable:**
```bash
git diff | claude \
  --max-turns 1 \
  -p "Review these changes for the task: <bead title>
  ..." \
  --output-format text \
  --allowedTools "Read,Glob,Grep"
```

@ENDIF_CLAUDECODE@
@IF_OPENCODE@
### Step 2: Polish Changes

Before review, automatically refine code for clarity. Extract modified files from the REVIEW JSON's `changes.files` array.

```
Use task tool to invoke polisher agent:
Task(description="Polish code changes", prompt="Polish the following files for clarity and consistency:

<list of modified files from REVIEW JSON changes.files>

Apply these principles:
- Preserve exact functionality (never change behavior)
- Reduce unnecessary complexity
- Improve naming clarity
- Follow project conventions from CLAUDE.md
- Remove dead code and redundancy
- Avoid nested ternaries (prefer if/else or switch)

Output: List of refinements made (file:line - change)", agent="polisher")
```

**If polisher unavailable:** Skip polishing and proceed directly to code review.

**After polisher completes:**
- If changes were made, stage them: `git add <polished files>`
- Proceed to sous-chef review

### Step 3: Code Review

Delegate to sous-chef (reviewer) agent:

```
Use task tool to invoke sous-chef agent:
Task(description="Review code changes for task <id>", prompt="Review the following changes for task: <bead title>

Task ID: <id>
Task description: <brief description>

Changes to review:
<git diff output or diff HEAD~1>

Project context:
<CLAUDE.md summary if available>

Review checklist:
- Correctness: Logic errors, edge cases, error handling
- Security: Input validation, secrets exposure, injection risks
- Style: Naming, consistency with codebase patterns
- Completeness: Does it fully address the task?

Output format:
1. Summary: Brief overall assessment
2. Verdict: ready_for_tidy | needs_changes | blocked
3. Issues found:
   - Severity: critical | major | minor | nit
   - File/line: Location
   - Issue: Description
   - Suggestion: How to fix
   - Auto-fixable: true | false
4. Positive notes: What was done well

CRITICAL: If verdict is 'blocked', explain why and what must be fixed.", agent="sous-chef")
```

**If sous-chef unavailable:** Perform inline review using the checklist above.

Wait for reviewer assessment. Address critical issues before proceeding to tidy.

@ENDIF_OPENCODE@
@IF_CLAUDECODE@
### Step 4: Process Review Results

Based on sous-chef verdict:

**If verdict is ready_for_tidy:**
- Proceed to Step 5
- No changes needed

**If verdict is needs_changes:**
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
### Step 4: Process Review Results

Based on sous-chef verdict:

**If verdict is ready_for_tidy:**
- Proceed to Step 5
- No changes needed

**If verdict is needs_changes:**
@ENDIF_OPENCODE@
- Report findings to user with SERVE_RESULT showing `next_step: /@NAMESPACE@cook`
- User will rerun `/@NAMESPACE@cook` with the review findings
- Do NOT continue to tidy

@IF_CLAUDECODE@
**If verdict is blocked:**
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
**If verdict is blocked:**
@ENDIF_OPENCODE@
- CRITICAL issues must be fixed before tidying
- Report blocking issues to user
- Recommend not proceeding to `/@NAMESPACE@tidy` until fixed
- Keep task as in_progress

@IF_CLAUDECODE@
### Step 5: Record and Report Results
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
### Step 5: Record and Report Results
@ENDIF_OPENCODE@

**Record via comment:**
```bash
bd comments add <bead-id> "PHASE: SERVE
Status: completed
Verdict: <approved|needs_changes|blocked>
Issues: <count> found (<auto-fixed>, <to-file>)
Summary: <brief assessment>"
```

**Output format:**

CRITICAL: The SERVE_RESULT block must be present and parseable by orchestrators.

```
╔══════════════════════════════════════════════════════════════╗
║  SERVE: Dish Presented                                       ║
╚══════════════════════════════════════════════════════════════╝

REVIEW: <id> - <title>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Summary:
  <brief overall assessment of the changes>

Auto-fixed:
  - <file>:<line> - <fix applied>

Issues to file in tidy (see tidy.md Finding Filing Strategy):
  Code/project findings (siblings under parent):
  - [P1] "<title>" - <description>
  - [P3] "<title>" - <description>
  - [P4] "<title>" - <minor code finding>
  Process improvements (under Retrospective epic):
  - [P4] "<title>" - <workflow suggestion>

Positive notes:
  - <good thing>
  - <good thing>

┌─────────────────────────────────────────┐
│ SERVE_RESULT                            │
│ verdict: APPROVED | NEEDS_CHANGES | BLOCKED │
│ continue: true | false                  │
│ next_step: /@NAMESPACE@tidy | /@NAMESPACE@cook      │
│ blocking_issues: <count or 0>           │
└─────────────────────────────────────────┘

NEXT STEP: /@NAMESPACE@tidy (if APPROVED) or /@NAMESPACE@cook (if NEEDS_CHANGES)
```

**Verdict meanings:**
- **APPROVED**: No issues found, continue to tidy
- **NEEDS_CHANGES**: Issues found requiring rework. Rerun /@NAMESPACE@cook with findings.
- **BLOCKED**: Critical issues require fixing before commit. STOP workflow.

@IF_CLAUDECODE@
**Phase completion signal:** After outputting the SERVE_RESULT block, emit the phase completion signal:
```
<phase_complete>DONE</phase_complete>
```
This signals to the line-loop orchestrator that the serve phase has completed its work and can be terminated early, avoiding unnecessary wait for timeout.

@ENDIF_CLAUDECODE@
## Error Handling

@IF_CLAUDECODE@
If the sous-chef agent or headless Claude invocation fails (API error, timeout, etc.):
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
If the sous-chef agent or review cannot be completed (tool failure, timeout, etc.):
@ENDIF_OPENCODE@

```
⚠️ REVIEW SKIPPED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Reason: <error message>

Manual review recommended. Run /@NAMESPACE@serve again after /@NAMESPACE@tidy.

┌─────────────────────────────────────────┐
│ SERVE_RESULT                            │
│ verdict: SKIPPED                        │
│ continue: true                          │
│ blocking_issues: 0                      │
│ retry_recommended: true                 │
└─────────────────────────────────────────┘
```

@IF_CLAUDECODE@
API errors are transient - workflow continues but recommends retry later.
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
Errors are transient - workflow continues but recommends retry later.
@ENDIF_OPENCODE@

## Example Usage

```
/@NAMESPACE@serve              # Review most recent closed bead
/@NAMESPACE@serve lc-042       # Review specific bead
```
