---
description: Run full workflow cycle (prep→cook→serve→tidy)
@IF_CLAUDECODE@
allowed-tools: Bash, Read, Write, Edit, Glob, Grep, Task, TodoWrite, AskUserQuestion, Skill
@ENDIF_CLAUDECODE@
---

## Summary

@IF_CLAUDECODE@
**Expeditor orchestrates full workflow: prep → cook → serve → tidy → plate.** Primary entry point for focused work sessions.

**Expeditor responsibilities:**
- Run prep checks and present ready tasks
- Delegate cooking to chef subagent
- Coordinate serving with sous-chef review
- Manage tidy phase (commit, push)
- Trigger plate phase for feature completion
- Handle failure conditions and coordinate recovery
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
**Run the full prep → cook → serve → tidy cycle.** Primary entry point for focused work sessions.
@ENDIF_OPENCODE@

**Arguments:** `$ARGUMENTS` (optional) - Specific task ID to work on (passed to cook)

---

## Process

@IF_OPENCODE@
Execute all steps in sequence without stopping between commands.

@ENDIF_OPENCODE@
### Step 1: Run /prep

@IF_CLAUDECODE@
Invoke the prep command to sync state and identify available work:

```
Skill(skill="@NAMESPACE@prep")
```
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
Read and follow `line-prep.md` to sync state and identify available work.
@ENDIF_OPENCODE@

Wait for prep to complete.

### Step 2: Run /cook

@IF_CLAUDECODE@
Invoke the cook command to execute work:

**If `$ARGUMENTS` provided:**
```
Skill(skill="@NAMESPACE@cook", args="$ARGUMENTS")
```

**Otherwise:**
```
Skill(skill="@NAMESPACE@cook")
```

Wait for cook to complete. Cook will select a task, execute the work, and output findings for tidy.
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
Read and follow `line-cook.md` to execute work.

**If `$ARGUMENTS` provided:** Pass the task ID to cook for explicit task selection.

**Otherwise:** Cook will auto-select the highest priority ready task.

Wait for cook to complete.
@ENDIF_OPENCODE@

### Step 3: Run /serve

@IF_CLAUDECODE@
Invoke the serve command for peer review:

```
Skill(skill="@NAMESPACE@serve")
```

Wait for review to complete. Serve will invoke sous-chef subagent for code review and categorize any issues found.
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
Read and follow `line-serve.md` for peer review.

Wait for review to complete. **Check SERVE_RESULT verdict:**

- If `continue: true` → proceed to Step 4
- If `continue: false` (BLOCKED) → STOP and wait for user decision (see Error Handling)
@ENDIF_OPENCODE@

### Step 4: Run /tidy

@IF_CLAUDECODE@
Invoke tidy to file discovered work, commit, and push:

```
Skill(skill="@NAMESPACE@tidy")
```

Tidy will file beads for discovered work, commit all changes, sync beads, and push to remote.
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
Read and follow `line-tidy.md` to file discovered work, commit, and push.

Tidy files discovered work, commits, syncs, and pushes.
@ENDIF_OPENCODE@

@IF_CLAUDECODE@
### Step 5: Check for Plate Phase (Feature Completion)
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
### Step 5: Check for Feature Completion
@ENDIF_OPENCODE@

After tidying, check if the task completed a feature:

```bash
@IF_CLAUDECODE@
# Get task details to check parent
@ENDIF_CLAUDECODE@
bd show <task-id>
```

**If task has a parent feature AND all sibling tasks are closed:**
@IF_CLAUDECODE@

1. Run feature validation:
   ```bash
   <test command>  # e.g., go test ./..., pytest, npm test, cargo test
   <feature test command>  # e.g., go test -run TestFeature, pytest tests/features/, npm test -- --grep "Feature"
   ```

2. Delegate to maître (BDD quality) subagent:
   ```
   Use Task tool to invoke maître subagent:
   Task(description="Review feature test quality", prompt="Review BDD tests for feature <feature-id>

   Feature: <feature-title>
   Acceptance criteria:
   - <criteria 1>
   - <criteria 2>
   - <criteria 3>

   Verify:
   - All acceptance criteria have tests
   - Given-When-Then structure used
   - Tests map to acceptance criteria
   - User perspective documented
   - Error scenarios included

   Report any critical issues before proceeding with plate phase.", subagent_type="maitre")
   ```

3. Wait for BDD quality assessment. Address any critical issues.

4. If BDD tests pass quality bar, proceed with plate phase:
   - Create feature acceptance documentation
   - Update CHANGELOG.md
   - Close feature bead
   - Commit and push feature report

**If no feature completed, skip plate phase and proceed to Step 6.**
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
- Run /@NAMESPACE@plate to validate the feature
- Create acceptance documentation
- Close feature bead
@ENDIF_OPENCODE@

### Step 6: Cycle Summary

@IF_CLAUDECODE@
After all steps complete, output summary derived from /tidy:
@ENDIF_CLAUDECODE@

```
@IF_CLAUDECODE@
╔══════════════════════════════════════════════════════════════╗
║  FULL SERVICE COMPLETE                                       ║
╚══════════════════════════════════════════════════════════════╝

@ENDIF_CLAUDECODE@
WORK CYCLE: Complete
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

@IF_CLAUDECODE@
[1/5] PREP    ✓ synced
[2/5] COOK    ✓ executed
[3/5] SERVE   ✓ reviewed (<verdict>)
[4/5] TIDY    ✓ committed, pushed
[5/5] PLATE ✓ (feature complete) | (not applicable)

Quality Gates:
  [✓] Test quality approved (taster)
  [✓] Code quality approved (sous-chef)
  [✓] BDD tests approved (maître, if applicable)
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
[1/5] PREP    ✓ synced
[2/5] COOK    ✓ executed
[3/5] SERVE   ✓ reviewed
[4/5] TIDY    ✓ committed, pushed
[5/5] PLATE   ✓ (feature complete) | ○ (not applicable)
@ENDIF_OPENCODE@

──────────────────────────────────────────

TASK: <id> - <title>

INTENT:
  <1-2 sentences from task description>
  Goal: <deliverable or acceptance criteria>

BEFORE → AFTER:
  <previous state> → <new state>
  <what couldn't be done> → <what can be done now>

Files: <count> changed
Commit: <hash>
Issues filed: <count>

@IF_CLAUDECODE@
───────────────────────────────────────────
NEXT STEPS
───────────────────────────────────────────
Ready: <count> tasks | Blocked: <count>

  /clear       Clear context before next cycle (recommended)
  /@NAMESPACE@run    Continue with next task
  /@NAMESPACE@prep   Review state first
  /@NAMESPACE@help   See all commands

Tip: Clear context between tasks to prevent accumulation.
@ENDIF_CLAUDECODE@
```

## Error Handling

If any step fails:

@IF_CLAUDECODE@
1. **Prep fails** - Report sync error, stop workflow
2. **Cook fails** - Report what went wrong, offer to continue to tidy (to save progress)
3. **Serve fails** - Note review was skipped, continue to tidy
4. **Tidy fails** - Report push error, create bead for follow-up
5. **Plate fails** - Note feature validation incomplete, create bead for follow-up

```
WORK CYCLE: Incomplete
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1/5] PREP    ✓
[2/5] COOK    ✓
[3/5] SERVE   ✗ (error: <reason>)
[4/5] TIDY    pending
[5/5] PLATE pending

Failed at: <step>
Error: <description>

──────────────────────────────────────────

TASK: <id> - <title>

Run /@NAMESPACE@tidy to save progress, or investigate the error.

If plate failed, feature bead will remain open for validation when issues are resolved.
```
@ENDIF_CLAUDECODE@
@IF_OPENCODE@
- **Prep fails**: Report sync error, stop workflow
- **Cook fails**: Report error, offer to continue to tidy (to save progress)
- **Serve fails**: Check SERVE_RESULT verdict (see below)
- **Tidy fails**: Report push error, create bead for follow-up
- **Plate fails**: Note feature validation incomplete, create bead

### Serve Verdict Handling

After serve completes, check the SERVE_RESULT block:

| Verdict | continue | Action |
|---------|----------|--------|
| `APPROVED` | true | Continue to tidy |
| `NEEDS_CHANGES` | true | Loop back to cook (rework) |
| `SKIPPED` | true | Continue to tidy with retry recommendation |
| `BLOCKED` | false | **STOP workflow** - require user decision |

**On NEEDS_CHANGES verdict (Rework Loop):**
1. Reopen the task: `bd update <id> --status=in_progress`
2. Run /@NAMESPACE@cook again (task will detect rework mode via serve comments)
3. Run /@NAMESPACE@serve again
4. Repeat until APPROVED or BLOCKED
5. Maximum 3 rework attempts before requiring user decision

```
REWORK REQUIRED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Review found issues that should be addressed:

<list issues from SERVE_RESULT>

Looping back to /@NAMESPACE@cook for rework (attempt <n>/3)...
```

**On BLOCKED verdict:**
```
WORKFLOW STOPPED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Review found blocking issues that must be addressed:

<list blocking issues from SERVE_RESULT>

Options:
1. Fix the issues, then run /@NAMESPACE@run again
2. Override: run /@NAMESPACE@tidy directly (skips review gate)
3. Abandon: leave changes uncommitted for manual handling

Waiting for user decision...
```

**On SKIPPED verdict (API error):**
```
Review skipped due to API error. Continuing to tidy.
Recommendation: Run /@NAMESPACE@serve manually after tidy completes.
```
@ENDIF_OPENCODE@

## Design Notes

The `/@NAMESPACE@run` command is the recommended entry point for focused work sessions. It:

1. **Ensures proper setup** - Prep runs first to sync state
2. **Maintains focus** - One task per cycle
3. **Enforces quality** - Serve reviews before commit
4. **Guarantees completion** - Tidy pushes changes

For exploratory sessions or when you need more control, use the individual commands directly.

## Example Usage

```
/@NAMESPACE@run              # Full cycle with auto-selected task
/@NAMESPACE@run lc-042       # Full cycle with specific task
```
