#!/bin/sh
#
# Line-cook pre-push hook
#
# Enforces session completion discipline:
# 1. Warns if in_progress beads exist without recent commits
# 2. Optionally runs bd sync automatically before push
#
# Skip with: SKIP_SESSION_CHECK=1 git push
# Or: git push --no-verify

# === SESSION CHECK ===

# Skip if SKIP_SESSION_CHECK=1
if [ "$SKIP_SESSION_CHECK" = "1" ]; then
    echo "Skipping session check (SKIP_SESSION_CHECK=1)"
    exit 0
fi

# Check if bd is available
if ! command -v bd >/dev/null 2>&1; then
    # No bd command - silently pass (not a beads-enabled project for this user)
    exit 0
fi

# Check if we're in a bd workspace
# For worktrees, .beads is in the main repository root, not the worktree
BEADS_DIR=""
if git rev-parse --git-dir >/dev/null 2>&1; then
    # Check if we're in a worktree
    if [ "$(git rev-parse --git-dir)" != "$(git rev-parse --git-common-dir)" ]; then
        # Worktree: .beads is in main repo root
        MAIN_REPO_ROOT="$(git rev-parse --git-common-dir)"
        MAIN_REPO_ROOT="$(dirname "$MAIN_REPO_ROOT")"
        if [ -d "$MAIN_REPO_ROOT/.beads" ]; then
            BEADS_DIR="$MAIN_REPO_ROOT/.beads"
        fi
    else
        # Regular repo: check current directory
        if [ -d .beads ]; then
            BEADS_DIR=".beads"
        fi
    fi
fi

if [ -z "$BEADS_DIR" ]; then
    # Not a beads workspace
    exit 0
fi

# Check for in_progress issues
# bd list --status=in_progress shows issues like: ◐ lc-xxx [● P2] [feature] - Title
# Count non-empty lines from the filtered output
in_progress_output=$(bd list --status=in_progress 2>/dev/null)
if [ -n "$in_progress_output" ]; then
    in_progress_count=$(printf '%s\n' "$in_progress_output" | grep -c . 2>/dev/null)
    # Ensure we have a valid number
    in_progress_count=${in_progress_count:-0}
else
    in_progress_count=0
fi

if [ "$in_progress_count" -gt 0 ]; then
    printf '\033[1;33m⚠️  WARNING: %d issue(s) still in_progress\033[0m\n' "$in_progress_count"
    echo ""
    echo "In-progress issues:"
    bd list --status=in_progress 2>/dev/null | head -10  # Show first 10 for readability
    echo ""
    echo "Session discipline reminder:"
    echo "  - Close completed issues: bd close <id>"
    echo "  - Or keep them open if work continues"
    echo ""
    echo "To push anyway:"
    echo "  SKIP_SESSION_CHECK=1 git push"
    echo "  git push --no-verify"
    echo ""
    # This is a warning, not a block - allow push to continue
    # Change 'exit 0' to 'exit 1' for strict enforcement
fi

# === BD SYNC ===

# Run bd sync to ensure all changes are committed
# This catches any pending database changes that weren't flushed
if ! bd sync --flush-only >/dev/null 2>&1; then
    printf '\033[1;33mWarning: bd sync --flush-only failed\033[0m\n' >&2
    echo "Run 'bd sync' manually to diagnose" >&2
    # Don't block push for sync failures
fi

# Check if there are uncommitted .beads changes after sync
if [ -n "$(git status --porcelain "$BEADS_DIR" 2>/dev/null)" ]; then
    printf '\033[1;33m⚠️  WARNING: Uncommitted .beads/ changes detected\033[0m\n'
    echo ""
    echo "The following beads files have uncommitted changes:"
    git status --porcelain "$BEADS_DIR" 2>/dev/null
    echo ""
    echo "Consider committing these before pushing:"
    echo "  git add $BEADS_DIR && git commit -m 'chore: sync beads state'"
    echo ""
    # Warning only - don't block
fi

exit 0
